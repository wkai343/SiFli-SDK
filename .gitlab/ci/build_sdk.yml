# GitLab CI åŠ¨æ€æ„å»ºç³»ç»Ÿ
# è¿è¡Œæ—¶åŠ¨æ€è§£æé…ç½®å¹¶ç”Ÿæˆå­Pipeline

# åŠ¨æ€Pipelineç”ŸæˆJob
generate_dynamic_pipeline:
  stage: build
  tags:
    - build
  script:
    - echo "ğŸš€ å¼€å§‹åŠ¨æ€ç”Ÿæˆæ„å»ºPipeline..."
    - python3 tools/ci/dynamic_pipeline.py -c build_config_gcc.yaml -o child-pipeline.yml
    - echo "ğŸ“„ ç”Ÿæˆçš„å­Pipelineé…ç½®:"
    - head -20 child-pipeline.yml
    - echo "..."
  artifacts:
    paths:
      - child-pipeline.yml
    expire_in: 1 hour
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "api" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always

# è§¦å‘åŠ¨æ€ç”Ÿæˆçš„å­Pipeline
trigger_child_pipeline:
  stage: build
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: generate_dynamic_pipeline
    strategy: depend
  needs:
    - generate_dynamic_pipeline
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "api" && $BUILD_SDK'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
