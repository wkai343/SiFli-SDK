# cpu_usage_profilerç¤ºä¾‹
æºç è·¯å¾„ï¼šexample/system/cpu_usage_profiler
## æ”¯æŒçš„å¹³å°
<!-- æ”¯æŒå“ªäº›æ¿å­å’ŒèŠ¯ç‰‡å¹³å° -->
+ sf32lb52-lcd_n16r8

## æ¦‚è¿°
<!-- ä¾‹ç¨‹ç®€ä»‹ -->
ä¾‹ç¨‹æ¼”ç¤ºcpu_usage_profilerçš„é…ç½®ä½¿ç”¨ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
+ CPUä½¿ç”¨ç»Ÿè®¡ï¼šç©ºé—²æ—¶é—´ï¼ˆidle_run_timeï¼‰ã€éç©ºé—²æ—¶é—´ï¼ˆother_run_timeï¼‰ã€CPUä½¿ç”¨ç‡ï¼ˆé»˜è®¤2sç»Ÿè®¡ä¸€æ¬¡ï¼‰ã€‚
+ çº¿ç¨‹åˆ‡æ¢å†å²è®°å½•ã€‚è®°å½•æ¯æ¬¡çº¿ç¨‹åˆ‡æ¢çš„çº¿ç¨‹åã€åˆ‡æ¢å‘ç”Ÿçš„æ—¶é—´ã€‚
+ ä¸­æ–­å†å²è®°å½•ã€‚è®°å½•ä¸­æ–­çš„ä¸­æ–­å·ã€ä¸­æ–­è§¦å‘æ—¶é—´ã€‚
+ CPU Usage Metricsã€‚è®°å½•CPUç©ºé—²æ—¶é—´ï¼ˆidle timeï¼‰ã€éç©ºé—²æ—¶é—´ï¼ˆother run timeï¼‰ã€çº¿ç¨‹è¿è¡Œæ—¶é—´ï¼ˆthread run timeï¼‰ã€‚æ”¯æŒï¼š
     + å‘¨æœŸæ‰“å°ã€‚
     + é€šè¿‡`Metrics Collector`åŠŸèƒ½æ”¶é›†å­˜å‚¨ã€‚

```{tip}
+ çº¿ç¨‹åˆ‡æ¢ã€ä¸­æ–­è®°å½•çš„æ—¶é—´æ˜¯æ ¹æ®GTIMERè®¡ç®—çš„å¼€æœºæ—¶é—´ï¼ˆç§’/å¾®ç§’ï¼‰ã€‚
+ `CPU Usage Metrics`çš„ç»Ÿè®¡ä¿¡æ¯åœ¨æ¯æ¬¡æ”¶é›†æˆ–è€…æ‰“å°åæ¸…é™¤é‡å¯å¼€å§‹ç»Ÿè®¡ã€‚
```

## ä¾‹ç¨‹çš„ä½¿ç”¨
<!-- è¯´æ˜å¦‚ä½•ä½¿ç”¨ä¾‹ç¨‹ï¼Œæ¯”å¦‚è¿æ¥å“ªäº›ç¡¬ä»¶ç®¡è„šè§‚å¯Ÿæ³¢å½¢ï¼Œç¼–è¯‘å’Œçƒ§å†™å¯ä»¥å¼•ç”¨ç›¸å…³æ–‡æ¡£ã€‚
å¯¹äºrt_deviceçš„ä¾‹ç¨‹ï¼Œè¿˜éœ€è¦æŠŠæœ¬ä¾‹ç¨‹ç”¨åˆ°çš„é…ç½®å¼€å…³åˆ—å‡ºæ¥ï¼Œæ¯”å¦‚PWMä¾‹ç¨‹ç”¨åˆ°äº†PWM1ï¼Œéœ€è¦åœ¨onchipèœå•é‡Œä½¿èƒ½PWM1 -->

### ç¡¬ä»¶éœ€æ±‚
è¿è¡Œè¯¥ä¾‹ç¨‹å‰ï¼Œéœ€è¦å‡†å¤‡ä¸€å—æœ¬ä¾‹ç¨‹æ”¯æŒçš„å¼€å‘æ¿ã€‚

### menuconfigé…ç½®
1. ä½¿èƒ½cpu usage profilerï¼ˆæ€»å¼€å…³ï¼‰ï¼š  
![CPU_USAGE_PROFILER](./assets/cpu_usage_profiler.png)
2. é…ç½®ä»»åŠ¡åˆ‡æ¢è®°å½•æ•°é‡ï¼š  
![thread_switch_hist_num](./assets/thread_switch_hist_num.png)
3. é…ç½®ä¸­æ–­å†å²è®°å½•ï¼ˆä½¿èƒ½ã€é…ç½®è®°å½•æ•°é‡ï¼‰ï¼š  
![isr_hisotry](./assets/isr_hisotry.png)
4. é…ç½®CPU Usage Metricsï¼š    
4.1 ä½¿èƒ½Metricsï¼š  
![cpu_usage_metrics](./assets/cpu_usage_metrics.png)  
4.2 é…ç½®report typeï¼š    
![report_type](./assets/report_type.png)
     ```{tip}
     æœ¬ä¾‹ç¨‹ä¸­ï¼Œ`report type`é…æˆä¸ºå‘¨æœŸæ‰“å°ã€‚
     ```

### ç¼–è¯‘å’Œçƒ§å½•
åˆ‡æ¢åˆ°ä¾‹ç¨‹projectç›®å½•ï¼Œè¿è¡Œsconså‘½ä»¤æ‰§è¡Œç¼–è¯‘ï¼š
```
scons --board=sf32lb52-lcd_n16r8 -j32
```
è¿è¡Œ`build_sf32lb52-lcd_n16r8_hcpu\uart_download.bat`ï¼ŒæŒ‰æç¤ºé€‰æ‹©ç«¯å£å³å¯è¿›è¡Œä¸‹è½½ï¼š
```
$ ./uart_download.bat

     Uart Download

please input the serial port num:5
```
å…³äºç¼–è¯‘ã€ä¸‹è½½çš„è¯¦ç»†æ­¥éª¤ï¼Œè¯·å‚è€ƒ[](/quickstart/get-started.md)çš„ç›¸å…³ä»‹ç»ã€‚

## ä¾‹ç¨‹çš„é¢„æœŸç»“æœ
<!-- è¯´æ˜ä¾‹ç¨‹è¿è¡Œç»“æœï¼Œæ¯”å¦‚å“ªå‡ ä¸ªç¯ä¼šäº®ï¼Œä¼šæ‰“å°å“ªäº›logï¼Œä»¥ä¾¿ç”¨æˆ·åˆ¤æ–­ä¾‹ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œè¿è¡Œç»“æœå¯ä»¥ç»“åˆä»£ç åˆ†æ­¥éª¤è¯´æ˜ -->
1. çº¿ç¨‹åˆ‡æ¢å†å²ä¿å­˜åœ¨`thread_switch_hist`ï¼Œä¸­æ–­å†å²è®°å½•ä¿å­˜åœ¨`isr_hist`ï¼Œå¯ä»¥é€šè¿‡`ozone\T32`ç­‰åœ¨çº¿æˆ–è€…ç¦»çº¿æ‰‹æ®µæŸ¥çœ‹å˜é‡ã€‚æ¯”å¦‚ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¯ä»¥é€šè¿‡T32æ–¹ä¾¿åœ°çœ‹åˆ°çº¿ç¨‹åˆ‡æ¢è®°å½•ï¼š
![t32_switch_hist](./assets/t32_switch_hist.png)
2. é…ç½®CPU Usage Metricsä¸ºå‘¨æœŸæ‰“å°æ—¶ï¼Œä¼šå‘¨æœŸæ‰“å°`CPU Usage`ä¿¡æ¯ï¼ˆè¿™é‡Œé…ç½®çš„æ‰“å°å‘¨æœŸä¸º10sï¼‰ï¼š
     ```c
     07-03 17:59:52:616    [32m[328360] I/NO_TAG: ============================
     07-03 17:59:52:625    [0m[32m[328382] I/NO_TAG: CPU Usage:    9.93/   9.94 (   0.15%)
     07-03 17:59:52:632    [0m[32m[328411] I/NO_TAG: ========================================================
     07-03 17:59:52:641    [0m[32m[328442] I/NO_TAG: thread      run_time(s)    load(%)
     07-03 17:59:52:648    [0m[32m[328465] I/NO_TAG: --------------------------------------------------------
     07-03 17:59:52:662    [0m[32m[328496] I/NO_TAG: [tshell  ]:    0.01    0.15% 
     07-03 17:59:52:672    [0m[32m[328518] I/NO_TAG: [tidle   ]:    9.93   99.85% 
     07-03 17:59:52:680    [0m[32m[328540] I/NO_TAG: [timer   ]:    0.00    0.00% 
     07-03 17:59:52:692    [0m[32m[328562] I/NO_TAG: [main    ]:    0.00    0.00% 
     07-03 17:59:52:813    [0m
     07-03 18:00:02:607    [32m[656066] I/NO_TAG: ============================
     07-03 18:00:02:619    [0m[32m[656087] I/NO_TAG: CPU Usage:    9.99/  10.00 (   0.07%)
     07-03 18:00:02:627    [0m[32m[656112] I/NO_TAG: ========================================================
     07-03 18:00:02:637    [0m[32m[656143] I/NO_TAG: thread      run_time(s)    load(%)
     07-03 18:00:02:644    [0m[32m[656166] I/NO_TAG: --------------------------------------------------------
     07-03 18:00:02:653    [0m[32m[656197] I/NO_TAG: [tshell  ]:    0.00    0.00% 
     07-03 18:00:02:660    [0m[32m[656218] I/NO_TAG: [tidle   ]:    9.99   99.93% 
     07-03 18:00:02:670    [0m[32m[656240] I/NO_TAG: [timer   ]:    0.01    0.07% 
     07-03 18:00:02:678    [0m[32m[656262] I/NO_TAG: [main    ]:    0.00    0.00% 
     07-03 18:00:02:801    [0m
     07-03 18:00:12:602    [32m[983795] I/NO_TAG: ============================
     07-03 18:00:12:607    [0m[32m[983816] I/NO_TAG: CPU Usage:    9.99/  10.00 (   0.07%)
     07-03 18:00:12:809    [0m[32m[983841] I/NO_TAG: ========================================================
     07-03 18:00:12:830    [0m[32m[983872] I/NO_TAG: thread      run_time(s)    load(%)
     07-03 18:00:12:853    [0m[32m[983895] I/NO_TAG: --------------------------------------------------------
     07-03 18:00:12:865    [0m[32m[983926] I/NO_TAG: [tshell  ]:    0.00    0.00% 
     07-03 18:00:12:874    [0m[32m[983948] I/NO_TAG: [tidle   ]:    9.99   99.93% 
     07-03 18:00:12:883    [0m[32m[983970] I/NO_TAG: [timer   ]:    0.01    0.07% 
     07-03 18:00:12:897    [0m[32m[983991] I/NO_TAG: [main    ]:    0.00    0.00% 
     ```
3. æ”¯æŒçš„FINSHå‘½ä»¤ï¼š
     å‘½ä»¤|è¯´æ˜ 
     --|--
     `cpu_prof_init`|åˆå§‹åŒ–profileråŠŸèƒ½
     `cpu_prof_deinit`|å–æ¶ˆprofileråŠŸèƒ½
     `cpu_prof_reset`|é‡ç½®CPUç»Ÿè®¡æ•°æ®
     `cpu`|æ‰“å°CPUç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœä½¿èƒ½äº†`CPU Usage Metrics`ï¼Œä¹Ÿä¼šæ‰“å°å„çº¿ç¨‹è´Ÿè½½ï¼‰

     å¦‚ä¸‹ä¸º`cpu`å‘½ä»¤æ‰“å°ï¼ˆè¿™é‡Œä½¿èƒ½äº†`CPU Usage Metrics`ï¼‰:
     ```c
     07-03 23:35:53:806 TX:cpu
     07-03 23:35:53:811    [32m[1049619] I/NO_TAG: CPU usage: 0.33
     07-03 23:35:53:814    
     07-03 23:35:53:819    [0m[32m[1049637] I/NO_TAG: ============================
     07-03 23:35:53:822    [0m[32m[1049659] I/NO_TAG: CPU Usage:    1.94/   1.95 (   0.34%)
     07-03 23:35:53:828    [0m[32m[1049684] I/NO_TAG: ========================================================
     07-03 23:35:53:832    [0m[32m[1049715] I/NO_TAG: thread      run_time(s)    load(%)
     07-03 23:35:53:837    [0m[32m[1049739] I/NO_TAG: --------------------------------------------------------
     07-03 23:35:53:839    [0m[32m[1049770] I/NO_TAG: [tshell  ]:    0.00    0.00% 
     07-03 23:35:53:844    [0m[32m[1049792] I/NO_TAG: [tidle   ]:    1.94   99.66% 
     07-03 23:35:53:848    [0m[32m[1049814] I/NO_TAG: [timer   ]:    0.01    0.34% 
     07-03 23:35:53:852    [0m[32m[1049836] I/NO_TAG: [main    ]:    0.00    0.00% 
     ```


## å¼‚å¸¸è¯Šæ–­


## å‚è€ƒæ–‡æ¡£
<!-- å¯¹äºrt_deviceçš„ç¤ºä¾‹ï¼Œrt-threadå®˜ç½‘æ–‡æ¡£æä¾›çš„è¾ƒè¯¦ç»†è¯´æ˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç½‘é¡µé“¾æ¥ï¼Œä¾‹å¦‚ï¼Œå‚è€ƒRT-Threadçš„[RTCæ–‡æ¡£](https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/device/rtc/rtc) -->


## æ›´æ–°è®°å½•
|ç‰ˆæœ¬ |æ—¥æœŸ   |å‘å¸ƒè¯´æ˜ |
|:---|:---|:---|
|0.0.1 |07/2025 |åˆå§‹ç‰ˆæœ¬ |
| | | |
| | | |
